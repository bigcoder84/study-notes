# ç½‘ç»œç¼–ç¨‹

## ä¸€. é˜»å¡æ¨¡å¼ä¸éé˜»å¡æ¨¡å¼

### 1.1 é˜»å¡æ¨¡å¼

* é˜»å¡æ¨¡å¼ä¸‹ï¼Œç›¸å…³æ–¹æ³•éƒ½ä¼šå¯¼è‡´çº¿ç¨‹æš‚åœ
  * ServerSocketChannel.accept ä¼šåœ¨æ²¡æœ‰è¿æ¥å»ºç«‹æ—¶è®©çº¿ç¨‹æš‚åœ
  * SocketChannel.read ä¼šåœ¨æ²¡æœ‰æ•°æ®å¯è¯»æ—¶è®©çº¿ç¨‹æš‚åœ
  * é˜»å¡çš„è¡¨ç°å…¶å®å°±æ˜¯çº¿ç¨‹æš‚åœäº†ï¼Œæš‚åœæœŸé—´ä¸ä¼šå ç”¨ cpuï¼Œä½†çº¿ç¨‹ç›¸å½“äºé—²ç½®
* å•çº¿ç¨‹ä¸‹ï¼Œé˜»å¡æ–¹æ³•ä¹‹é—´ç›¸äº’å½±å“ï¼Œå‡ ä¹ä¸èƒ½æ­£å¸¸å·¥ä½œï¼Œéœ€è¦å¤šçº¿ç¨‹æ”¯æŒ
* ä½†å¤šçº¿ç¨‹ä¸‹ï¼Œæœ‰æ–°çš„é—®é¢˜ï¼Œä½“ç°åœ¨ä»¥ä¸‹æ–¹é¢
  * 32 ä½ jvm ä¸€ä¸ªçº¿ç¨‹ 320kï¼Œ64 ä½ jvm ä¸€ä¸ªçº¿ç¨‹ 1024kï¼Œå¦‚æœè¿æ¥æ•°è¿‡å¤šï¼Œå¿…ç„¶å¯¼è‡´ OOMï¼Œå¹¶ä¸”çº¿ç¨‹å¤ªå¤šï¼Œåè€Œä¼šå› ä¸ºé¢‘ç¹ä¸Šä¸‹æ–‡åˆ‡æ¢å¯¼è‡´æ€§èƒ½é™ä½
  * å¯ä»¥é‡‡ç”¨çº¿ç¨‹æ± æŠ€æœ¯æ¥å‡å°‘çº¿ç¨‹æ•°å’Œçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä½†æ²»æ ‡ä¸æ²»æœ¬ï¼Œå¦‚æœæœ‰å¾ˆå¤šè¿æ¥å»ºç«‹ï¼Œä½†é•¿æ—¶é—´ inactiveï¼Œä¼šé˜»å¡çº¿ç¨‹æ± ä¸­æ‰€æœ‰çº¿ç¨‹ï¼Œå› æ­¤ä¸é€‚åˆé•¿è¿æ¥ï¼Œåªé€‚åˆçŸ­è¿æ¥

æœåŠ¡å™¨ä»£ç ï¼š

```java
public class Server {
    public static void main(String[] args) {
        // åˆ›å»ºç¼“å†²åŒº
        ByteBuffer buffer = ByteBuffer.allocate(16);
        // è·å¾—æœåŠ¡å™¨é€šé“
        try(ServerSocketChannel server = ServerSocketChannel.open()) {
            // ä¸ºæœåŠ¡å™¨é€šé“ç»‘å®šç«¯å£
            server.bind(new InetSocketAddress(8080));
            // ç”¨æˆ·å­˜æ”¾è¿æ¥çš„é›†åˆ
            ArrayList<SocketChannel> channels = new ArrayList<>();
            // å¾ªç¯æ¥æ”¶è¿æ¥
            while (true) {
                System.out.println("before connecting...");
                // æ²¡æœ‰è¿æ¥æ—¶ï¼Œä¼šé˜»å¡çº¿ç¨‹
                SocketChannel socketChannel = server.accept();
                System.out.println("after connecting...");
                channels.add(socketChannel);
                // å¾ªç¯éå†é›†åˆä¸­çš„è¿æ¥
                for(SocketChannel channel : channels) {
                    System.out.println("before reading");
                    // å¤„ç†é€šé“ä¸­çš„æ•°æ®
                    // å½“é€šé“ä¸­æ²¡æœ‰æ•°æ®å¯è¯»æ—¶ï¼Œä¼šé˜»å¡çº¿ç¨‹
                    channel.read(buffer);
                    buffer.flip();
                    ByteBufferUtil.debugRead(buffer);
                    buffer.clear();
                    System.out.println("after reading");
                }
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
```

å®¢æˆ·ç«¯ä»£ç ï¼š

```java
public class Client {
    public static void main(String[] args) {
        try (SocketChannel socketChannel = SocketChannel.open()) {
            // å»ºç«‹è¿æ¥
            socketChannel.connect(new InetSocketAddress("localhost", 8080));
            System.out.println("waiting...");
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
```

è¿è¡Œç»“æœ

- å®¢æˆ·ç«¯-æœåŠ¡å™¨å»ºç«‹è¿æ¥å‰ï¼šæœåŠ¡å™¨ç«¯å› accepté˜»å¡

![](../images/31.png)

- å®¢æˆ·ç«¯-æœåŠ¡å™¨å»ºç«‹è¿æ¥åï¼Œå®¢æˆ·ç«¯å‘é€æ¶ˆæ¯å‰ï¼šæœåŠ¡å™¨ç«¯å› é€šé“ä¸ºç©ºè¢«é˜»å¡

![](../images/32.png)

- å®¢æˆ·ç«¯å‘é€æ•°æ®åï¼ŒæœåŠ¡å™¨å¤„ç†é€šé“ä¸­çš„æ•°æ®ã€‚å†æ¬¡è¿›å…¥å¾ªç¯æ—¶ï¼Œå†æ¬¡è¢«accepté˜»å¡

![](../images/33.png)

- ä¹‹å‰çš„å®¢æˆ·ç«¯å†æ¬¡å‘é€æ¶ˆæ¯**ï¼ŒæœåŠ¡å™¨ç«¯å› ä¸ºè¢«accepté˜»å¡**ï¼Œæ— æ³•å¤„ç†ä¹‹å‰å®¢æˆ·ç«¯å‘é€åˆ°é€šé“ä¸­çš„ä¿¡æ¯

![](../images/34.png)

### 1.2 éé˜»å¡æ¨¡å¼

* éé˜»å¡æ¨¡å¼ä¸‹ï¼Œç›¸å…³æ–¹æ³•éƒ½ä¼šä¸ä¼šè®©çº¿ç¨‹æš‚åœ
  * åœ¨ ServerSocketChannel.accept åœ¨æ²¡æœ‰è¿æ¥å»ºç«‹æ—¶ï¼Œä¼šè¿”å› nullï¼Œç»§ç»­è¿è¡Œ
  * SocketChannel.read åœ¨æ²¡æœ‰æ•°æ®å¯è¯»æ—¶ï¼Œä¼šè¿”å› 0ï¼Œä½†çº¿ç¨‹ä¸å¿…é˜»å¡ï¼Œå¯ä»¥å»æ‰§è¡Œå…¶å®ƒ SocketChannel çš„ read æˆ–æ˜¯å»æ‰§è¡Œ ServerSocketChannel.accept 
  * å†™æ•°æ®æ—¶ï¼Œçº¿ç¨‹åªæ˜¯ç­‰å¾…æ•°æ®å†™å…¥ Channel å³å¯ï¼Œæ— éœ€ç­‰ Channel é€šè¿‡ç½‘ç»œæŠŠæ•°æ®å‘é€å‡ºå»
* ä½†éé˜»å¡æ¨¡å¼ä¸‹ï¼Œå³ä½¿æ²¡æœ‰è¿æ¥å»ºç«‹ï¼Œå’Œå¯è¯»æ•°æ®ï¼Œçº¿ç¨‹ä»ç„¶åœ¨ä¸æ–­è¿è¡Œï¼Œç™½ç™½æµªè´¹äº†CPU
* æ•°æ®å¤åˆ¶è¿‡ç¨‹ä¸­ï¼Œçº¿ç¨‹å®é™…è¿˜æ˜¯é˜»å¡çš„ï¼ˆAIO æ”¹è¿›çš„åœ°æ–¹ï¼‰

```java
public class Server {
    public static void main(String[] args) {
        // åˆ›å»ºç¼“å†²åŒº
        ByteBuffer buffer = ByteBuffer.allocate(16);
        // è·å¾—æœåŠ¡å™¨é€šé“
        try(ServerSocketChannel server = ServerSocketChannel.open()) {
            // ä¸ºæœåŠ¡å™¨é€šé“ç»‘å®šç«¯å£
            server.bind(new InetSocketAddress(8080));
            // ç”¨æˆ·å­˜æ”¾è¿æ¥çš„é›†åˆ
            ArrayList<SocketChannel> channels = new ArrayList<>();
            // å¾ªç¯æ¥æ”¶è¿æ¥
            while (true) {
                // è®¾ç½®ä¸ºéé˜»å¡æ¨¡å¼ï¼Œæ²¡æœ‰è¿æ¥æ—¶è¿”å›nullï¼Œä¸ä¼šé˜»å¡çº¿ç¨‹
                server.configureBlocking(false);
                SocketChannel socketChannel = server.accept();
                // é€šé“ä¸ä¸ºç©ºæ—¶æ‰å°†è¿æ¥æ”¾å…¥åˆ°é›†åˆä¸­
                if (socketChannel != null) {
                    System.out.println("after connecting...");
                    channels.add(socketChannel);
                }
                // å¾ªç¯éå†é›†åˆä¸­çš„è¿æ¥
                for(SocketChannel channel : channels) {
                    // å¤„ç†é€šé“ä¸­çš„æ•°æ®
                    // è®¾ç½®ä¸ºéé˜»å¡æ¨¡å¼ï¼Œè‹¥é€šé“ä¸­æ²¡æœ‰æ•°æ®ï¼Œä¼šè¿”å›0ï¼Œä¸ä¼šé˜»å¡çº¿ç¨‹
                    channel.configureBlocking(false);
                    int read = channel.read(buffer);
                    if(read > 0) {
                        buffer.flip();
                        ByteBufferUtil.debugRead(buffer);
                        buffer.clear();
                        System.out.println("after reading");
                    }
                }
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
```

è¿™æ ·å†™å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œå› ä¸ºè®¾ç½®ä¸ºäº†éé˜»å¡ï¼Œä¼šä¸€ç›´æ‰§è¡Œwhile(true)ä¸­çš„ä»£ç ï¼ŒCPUä¸€ç›´å¤„äºå¿™ç¢ŒçŠ¶æ€ï¼Œä¼šä½¿å¾—æ€§èƒ½å˜ä½ï¼Œæ‰€ä»¥å®é™…æƒ…å†µä¸­ä¸ä½¿ç”¨è¿™ç§æ–¹æ³•å¤„ç†è¯·æ±‚

## äºŒ. å¤šè·¯å¤ç”¨

å•çº¿ç¨‹å¯ä»¥é…åˆ Selector å®Œæˆå¯¹å¤šä¸ª Channel å¯è¯»å†™äº‹ä»¶çš„ç›‘æ§ï¼Œè¿™ç§°ä¹‹ä¸ºå¤šè·¯å¤ç”¨

* **å¤šè·¯å¤ç”¨ä»…é’ˆå¯¹ç½‘ç»œ IO**ï¼Œæ™®é€šæ–‡ä»¶ IO æ²¡æ³•åˆ©ç”¨å¤šè·¯å¤ç”¨
* å¦‚æœä¸ç”¨ Selector çš„éé˜»å¡æ¨¡å¼ï¼Œçº¿ç¨‹å¤§éƒ¨åˆ†æ—¶é—´éƒ½åœ¨åšæ— ç”¨åŠŸï¼Œè€Œ Selector èƒ½å¤Ÿä¿è¯
  * æœ‰å¯è¿æ¥äº‹ä»¶æ—¶æ‰å»è¿æ¥
  * æœ‰å¯è¯»äº‹ä»¶æ‰å»è¯»å–
  * æœ‰å¯å†™äº‹ä»¶æ‰å»å†™å…¥
    * é™äºç½‘ç»œä¼ è¾“èƒ½åŠ›ï¼ŒChannel æœªå¿…æ—¶æ—¶å¯å†™ï¼Œä¸€æ—¦ Channel å¯å†™ï¼Œä¼šè§¦å‘ Selector çš„å¯å†™äº‹ä»¶

## ä¸‰. Selector

![](../images/9.png)

å¥½å¤„

* ä¸€ä¸ªçº¿ç¨‹é…åˆ selector å°±å¯ä»¥ç›‘æ§å¤šä¸ª channel çš„äº‹ä»¶ï¼Œäº‹ä»¶å‘ç”Ÿçº¿ç¨‹æ‰å»å¤„ç†ã€‚é¿å…éé˜»å¡æ¨¡å¼ä¸‹æ‰€åšæ— ç”¨åŠŸ
* è®©è¿™ä¸ªçº¿ç¨‹èƒ½å¤Ÿè¢«å……åˆ†åˆ©ç”¨
* èŠ‚çº¦äº†çº¿ç¨‹çš„æ•°é‡
* å‡å°‘äº†çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢

### 3.1 åˆ›å»º

```java
Selector selector = Selector.open();
```

### 3.2 Channelç»‘å®šSelector

åªæœ‰å°†Channelä¸Selectorç»‘å®šï¼ŒSelectoræ‰èƒ½ç›‘æ§Channelçš„äº‹ä»¶

```java
channel.configureBlocking(false);
SelectionKey key = channel.register(selector, SelectKey.OP_READ);
```

* **channel å¿…é¡»å·¥ä½œåœ¨éé˜»å¡æ¨¡å¼**
* FileChannel æ²¡æœ‰éé˜»å¡æ¨¡å¼ï¼Œå› æ­¤ä¸èƒ½é…åˆ selector ä¸€èµ·ä½¿ç”¨
* ç»‘å®šçš„äº‹ä»¶ç±»å‹å¯ä»¥æœ‰
  * connect - å®¢æˆ·ç«¯è¿æ¥æˆåŠŸæ—¶è§¦å‘ï¼ˆ`SelectKey.OP_CONNECT`ï¼‰
  * accept - æœåŠ¡å™¨ç«¯æˆåŠŸæ¥å—è¿æ¥æ—¶è§¦å‘ï¼ˆ`SelectKey.OP_ACCEPT`ï¼‰
  * read - æ•°æ®å¯è¯»å…¥æ—¶è§¦å‘ï¼Œæœ‰å› ä¸ºæ¥æ”¶èƒ½åŠ›å¼±ï¼Œæ•°æ®æš‚ä¸èƒ½è¯»å…¥çš„æƒ…å†µï¼ˆ`SelectKey.OP_READ`ï¼‰
  * write - æ•°æ®å¯å†™å‡ºæ—¶è§¦å‘ï¼Œæœ‰å› ä¸ºå‘é€èƒ½åŠ›å¼±ï¼Œæ•°æ®æš‚ä¸èƒ½å†™å‡ºçš„æƒ…å†µï¼ˆ`SelectKey.OP_WRITE`ï¼‰

### 3.3 ç›‘å¬Channeläº‹ä»¶

å¯ä»¥é€šè¿‡ä¸‹é¢ä¸‰ç§æ–¹æ³•æ¥ç›‘å¬æ˜¯å¦æœ‰äº‹ä»¶å‘ç”Ÿï¼Œæ–¹æ³•çš„è¿”å›å€¼ä»£è¡¨æœ‰å¤šå°‘ channel å‘ç”Ÿäº†äº‹ä»¶

- æ–¹æ³•1ï¼šé˜»å¡ç›´åˆ°ç»‘å®šäº‹ä»¶å‘ç”Ÿ

```java
int count = selector.select();
```

- æ–¹æ³•2ï¼šé˜»å¡ç›´åˆ°ç»‘å®šäº‹ä»¶å‘ç”Ÿï¼Œæˆ–æ˜¯è¶…æ—¶ï¼ˆæ—¶é—´å•ä½ä¸º msï¼‰

```java
int count = selector.select(long timeout);
```

- æ–¹æ³•3ï¼šä¸ä¼šé˜»å¡ï¼Œä¹Ÿå°±æ˜¯ä¸ç®¡æœ‰æ²¡æœ‰äº‹ä»¶ï¼Œç«‹åˆ»è¿”å›ï¼Œè‡ªå·±æ ¹æ®è¿”å›å€¼æ£€æŸ¥æ˜¯å¦æœ‰äº‹ä»¶

```java
int count = selector.selectNow();
```

**ğŸ’¡ select ä½•æ—¶ä¸é˜»å¡**

 * äº‹ä»¶å‘ç”Ÿæ—¶
   * å®¢æˆ·ç«¯å‘èµ·è¿æ¥è¯·æ±‚ï¼Œä¼šè§¦å‘ accept äº‹ä»¶
   * å®¢æˆ·ç«¯å‘é€æ•°æ®è¿‡æ¥ï¼Œå®¢æˆ·ç«¯æ­£å¸¸ã€å¼‚å¸¸å…³é—­æ—¶ï¼Œéƒ½ä¼šè§¦å‘ read äº‹ä»¶ï¼Œå¦å¤–å¦‚æœå‘é€çš„æ•°æ®å¤§äº buffer ç¼“å†²åŒºï¼Œä¼šè§¦å‘å¤šæ¬¡è¯»å–äº‹ä»¶
   * channel å¯å†™ï¼Œä¼šè§¦å‘ write äº‹ä»¶
   * åœ¨ linux ä¸‹ nio bug å‘ç”Ÿæ—¶
 * è°ƒç”¨ selector.wakeup()
 * è°ƒç”¨ selector.close()
 * selector æ‰€åœ¨çº¿ç¨‹ interrupt

### 3.4 å¤„ç†acceptäº‹ä»¶

å®¢æˆ·ç«¯ä»£ç ä¸º

```java
public class Client {
    public static void main(String[] args) {
        try (Socket socket = new Socket("localhost", 8080)) {
            System.out.println(socket);
            socket.getOutputStream().write("world".getBytes());
            System.in.read();
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
```

æœåŠ¡å™¨ç«¯ä»£ç ä¸º

```java
@Slf4j
public class ChannelDemo6 {
    public static void main(String[] args) {
        try (ServerSocketChannel channel = ServerSocketChannel.open()) {
            channel.bind(new InetSocketAddress(8080));
            System.out.println(channel);
            Selector selector = Selector.open();
            channel.configureBlocking(false);
            channel.register(selector, SelectionKey.OP_ACCEPT);

            while (true) {
                int count = selector.select();
                log.debug("select count: {}", count);

                // è·å–æ‰€æœ‰äº‹ä»¶
                Set<SelectionKey> keys = selector.selectedKeys();

                // éå†æ‰€æœ‰äº‹ä»¶ï¼Œé€ä¸€å¤„ç†
                Iterator<SelectionKey> iter = keys.iterator();
                while (iter.hasNext()) {
                    SelectionKey key = iter.next();
                    // åˆ¤æ–­äº‹ä»¶ç±»å‹
                    if (key.isAcceptable()) {
                        ServerSocketChannel c = (ServerSocketChannel) key.channel();
                        // å¿…é¡»å¤„ç†
                        SocketChannel sc = c.accept();
                        log.debug("{}", sc);
                    }
                    // å¤„ç†å®Œæ¯•ï¼Œå¿…é¡»å°†äº‹ä»¶ç§»é™¤ã€‚å¦‚æœä¸ç§»é™¤åˆ™ä¼šç»§ç»­å¾…åœ¨selectedKeysä¸­ï¼Œå¦‚æœä¸‹æ¬¡å…¶å®ƒäº‹ä»¶å‘ç”Ÿï¼Œåœ¨è°ƒç”¨selector.selectedKeys()æ—¶ï¼Œåˆä¼šè·å–åˆ°å½“å‰SelectKey
                    iter.remove();
                }
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
```

**ğŸ’¡ äº‹ä»¶å‘ç”Ÿåèƒ½å¦ä¸å¤„ç†**

äº‹ä»¶å‘ç”Ÿåï¼Œè¦ä¹ˆå¤„ç†ï¼Œè¦ä¹ˆå–æ¶ˆï¼ˆcancelï¼‰ï¼Œä¸èƒ½ä»€ä¹ˆéƒ½ä¸åšï¼Œå¦åˆ™ä¸‹æ¬¡è¯¥äº‹ä»¶ä»ä¼šè§¦å‘ï¼Œè¿™æ˜¯å› ä¸º NIO åº•å±‚ä½¿ç”¨çš„æ˜¯æ°´å¹³è§¦å‘ã€‚cancelæ“ä½œç›¸å½“äºåæ³¨å†Œï¼Œå°±æ˜¯å°†å½“å‰SelectKeyä»Selectoræ³¨å†Œåˆ—è¡¨ä¸­ç§»é™¤ï¼ŒSelectorä»æ­¤ä»¥åä¸ä¼šåœ¨ç›‘å¬è¿™ä¸ªSelectKeyå¯¹åº”çš„Channelçš„äº‹ä»¶äº†ã€‚

### 3.5 å¤„ç†readäº‹ä»¶

```java
@Slf4j
public class ChannelDemo6 {
    public static void main(String[] args) {
        try (ServerSocketChannel channel = ServerSocketChannel.open()) {
            channel.bind(new InetSocketAddress(8080));
            System.out.println(channel);
            Selector selector = Selector.open();
            channel.configureBlocking(false);
            channel.register(selector, SelectionKey.OP_ACCEPT);

            while (true) {
                int count = selector.select();
                log.debug("select count: {}", count);

                // è·å–æ‰€æœ‰äº‹ä»¶
                Set<SelectionKey> keys = selector.selectedKeys();

                // éå†æ‰€æœ‰äº‹ä»¶ï¼Œé€ä¸€å¤„ç†
                Iterator<SelectionKey> iter = keys.iterator();
                while (iter.hasNext()) {
                    SelectionKey key = iter.next();
                    // åˆ¤æ–­äº‹ä»¶ç±»å‹
                    if (key.isAcceptable()) {
                        ServerSocketChannel c = (ServerSocketChannel) key.channel();
                        // å¿…é¡»å¤„ç†
                        SocketChannel sc = c.accept();
                        sc.configureBlocking(false);
                        sc.register(selector, SelectionKey.OP_READ);
                        log.debug("è¿æ¥å·²å»ºç«‹: {}", sc);
                    } else if (key.isReadable()) {
                        try {
                                SocketChannel sc = (SocketChannel) key.channel();
                                ByteBuffer buffer = ByteBuffer.allocate(128);
                                int read = sc.read(buffer);
                                //å¦‚æœæ˜¯æ­£å¸¸é€€å‡ºï¼ˆç”¨æˆ·çš„æ­£å¸¸é€€å‡ºæ“ä½œï¼Œä¹Ÿä¼šè§¦å‘Readäº‹ä»¶ï¼‰
                                if(read == -1) {
                                    key.cancel();
                                    sc.close();
                                } else {
                                    buffer.flip();
                                    debug(buffer);
                                }
                            } catch (IOException e) {
                                //å¤„ç†éæ­£å¸¸é€€å‡º
                                log.info("å®¢æˆ·ç«¯éæ­£å¸¸é€€å‡º->{}", this.name);
                                selectionKey.cancel();
                                try {
                                    channel.close();
                                } catch (IOException ioException) {
                                    ioException.printStackTrace();
                                }
                        	}
                    }
                    // å¤„ç†å®Œæ¯•ï¼Œå¿…é¡»å°†äº‹ä»¶ç§»é™¤
                    iter.remove();
                }
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
```

å¼€å¯ä¸¤ä¸ªå®¢æˆ·ç«¯ï¼Œä¿®æ”¹ä¸€ä¸‹å‘é€æ–‡å­—ï¼Œè¾“å‡ºï¼š

```txt
sun.nio.ch.ServerSocketChannelImpl[/0:0:0:0:0:0:0:0:8080]
21:16:39 [DEBUG] [main] c.i.n.ChannelDemo6 - select count: 1
21:16:39 [DEBUG] [main] c.i.n.ChannelDemo6 - è¿æ¥å·²å»ºç«‹: java.nio.channels.SocketChannel[connected local=/127.0.0.1:8080 remote=/127.0.0.1:60367]
21:16:39 [DEBUG] [main] c.i.n.ChannelDemo6 - select count: 1
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 68 65 6c 6c 6f                                  |hello           |
+--------+-------------------------------------------------+----------------+
21:16:59 [DEBUG] [main] c.i.n.ChannelDemo6 - select count: 1
21:16:59 [DEBUG] [main] c.i.n.ChannelDemo6 - è¿æ¥å·²å»ºç«‹: java.nio.channels.SocketChannel[connected local=/127.0.0.1:8080 remote=/127.0.0.1:60378]
21:16:59 [DEBUG] [main] c.i.n.ChannelDemo6 - select count: 1
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 77 6f 72 6c 64                                  |world           |
+--------+-------------------------------------------------+----------------+
```

**ğŸ’¡ä¸ºä½•è¦ iter.remove()**

å› ä¸º select åœ¨äº‹ä»¶å‘ç”Ÿåï¼Œå°±ä¼šå°†ç›¸å…³çš„ key æ”¾å…¥ selectedKeys é›†åˆï¼Œä½†ä¸ä¼šåœ¨å¤„ç†å®Œåè‡ªåŠ¨ä» selectedKeys é›†åˆä¸­ç§»é™¤ï¼Œéœ€è¦æˆ‘ä»¬è‡ªå·±åˆ é™¤ã€‚ä¾‹å¦‚

 * ç¬¬ä¸€æ¬¡è§¦å‘äº† ssckey ä¸Šçš„ accept äº‹ä»¶ï¼Œæ²¡æœ‰ç§»é™¤ ssckey 
 * ç¬¬äºŒæ¬¡è§¦å‘äº† sckey ä¸Šçš„ read äº‹ä»¶ï¼Œä½†è¿™æ—¶ selectedKeys ä¸­è¿˜æœ‰ä¸Šæ¬¡çš„ ssckey ï¼Œåœ¨å¤„ç†æ—¶å› ä¸ºæ²¡æœ‰çœŸæ­£çš„ serverSocket è¿ä¸Šäº†ï¼Œå°±ä¼šå¯¼è‡´ç©ºæŒ‡é’ˆå¼‚å¸¸

**ğŸ’¡ cancel çš„ä½œç”¨**

can  ä¼šå†ç›‘å¬äº‹ä»¶

#### 3.5.1 å¤„ç†æ¶ˆæ¯è¾¹ç•Œ

![](../images/10.png)

* ä¸€ç§æ€è·¯æ˜¯å›ºå®šæ¶ˆæ¯é•¿åº¦ï¼Œæ•°æ®åŒ…å¤§å°ä¸€æ ·ï¼ŒæœåŠ¡å™¨æŒ‰é¢„å®šé•¿åº¦è¯»å–ï¼Œç¼ºç‚¹æ˜¯æµªè´¹å¸¦å®½

* å¦ä¸€ç§æ€è·¯æ˜¯æŒ‰åˆ†éš”ç¬¦æ‹†åˆ†ï¼Œç¼ºç‚¹æ˜¯æ•ˆç‡ä½

* TLV æ ¼å¼ï¼Œå³ Type ç±»å‹ã€Length é•¿åº¦ã€Value æ•°æ®ï¼Œç±»å‹å’Œé•¿åº¦å·²çŸ¥çš„æƒ…å†µä¸‹ï¼Œå°±å¯ä»¥æ–¹ä¾¿è·å–æ¶ˆæ¯å¤§å°ï¼Œåˆ†é…åˆé€‚çš„ bufferï¼Œç¼ºç‚¹æ˜¯ buffer éœ€è¦æå‰åˆ†é…ï¼Œå¦‚æœå†…å®¹è¿‡å¤§ï¼Œåˆ™å½±å“ server ååé‡

  * Http 1.1 æ˜¯ TLV æ ¼å¼
  * Http 2.0 æ˜¯ LTV æ ¼å¼

  ![](../images/11.png)

æœåŠ¡å™¨ç«¯

```java
private static void split(ByteBuffer source) {
    source.flip();
    for (int i = 0; i < source.limit(); i++) {
        // æ‰¾åˆ°ä¸€æ¡å®Œæ•´æ¶ˆæ¯
        if (source.get(i) == '\n') {
            int length = i + 1 - source.position();
            // æŠŠè¿™æ¡å®Œæ•´æ¶ˆæ¯å­˜å…¥æ–°çš„ ByteBuffer
            ByteBuffer target = ByteBuffer.allocate(length);
            // ä» source è¯»ï¼Œå‘ target å†™
            for (int j = 0; j < length; j++) {
                target.put(source.get());
            }
            debugAll(target);
        }
    }
    source.compact(); // 0123456789abcdef  position 16 limit 16
}

public static void main(String[] args) throws IOException {
    // 1. åˆ›å»º selector, ç®¡ç†å¤šä¸ª channel
    Selector selector = Selector.open();
    ServerSocketChannel ssc = ServerSocketChannel.open();
    ssc.configureBlocking(false);
    // 2. å»ºç«‹ selector å’Œ channel çš„è”ç³»ï¼ˆæ³¨å†Œï¼‰
    // SelectionKey å°±æ˜¯å°†æ¥äº‹ä»¶å‘ç”Ÿåï¼Œé€šè¿‡å®ƒå¯ä»¥çŸ¥é“äº‹ä»¶å’Œå“ªä¸ªchannelçš„äº‹ä»¶
    SelectionKey sscKey = ssc.register(selector, 0, null);
    // key åªå…³æ³¨ accept äº‹ä»¶
    sscKey.interestOps(SelectionKey.OP_ACCEPT);
    log.debug("sscKey:{}", sscKey);
    ssc.bind(new InetSocketAddress(8080));
    while (true) {
        // 3. select æ–¹æ³•, æ²¡æœ‰äº‹ä»¶å‘ç”Ÿï¼Œçº¿ç¨‹é˜»å¡ï¼Œæœ‰äº‹ä»¶ï¼Œçº¿ç¨‹æ‰ä¼šæ¢å¤è¿è¡Œ
        // select åœ¨äº‹ä»¶æœªå¤„ç†æ—¶ï¼Œå®ƒä¸ä¼šé˜»å¡, äº‹ä»¶å‘ç”Ÿåè¦ä¹ˆå¤„ç†ï¼Œè¦ä¹ˆå–æ¶ˆï¼Œä¸èƒ½ç½®ä¹‹ä¸ç†
        selector.select();
        // 4. å¤„ç†äº‹ä»¶, selectedKeys å†…éƒ¨åŒ…å«äº†æ‰€æœ‰å‘ç”Ÿçš„äº‹ä»¶
        Iterator<SelectionKey> iter = selector.selectedKeys().iterator(); // accept, read
        while (iter.hasNext()) {
            SelectionKey key = iter.next();
            // å¤„ç†key æ—¶ï¼Œè¦ä» selectedKeys é›†åˆä¸­åˆ é™¤ï¼Œå¦åˆ™ä¸‹æ¬¡å¤„ç†å°±ä¼šæœ‰é—®é¢˜
            iter.remove();
            log.debug("key: {}", key);
            // 5. åŒºåˆ†äº‹ä»¶ç±»å‹
            if (key.isAcceptable()) { // å¦‚æœæ˜¯ accept
                ServerSocketChannel channel = (ServerSocketChannel) key.channel();
                SocketChannel sc = channel.accept();
                sc.configureBlocking(false);
                ByteBuffer buffer = ByteBuffer.allocate(16); // attachment
                // å°†ä¸€ä¸ª byteBuffer ä½œä¸ºé™„ä»¶å…³è”åˆ° selectionKey ä¸Š
                SelectionKey scKey = sc.register(selector, 0, buffer);
                scKey.interestOps(SelectionKey.OP_READ);
                log.debug("{}", sc);
                log.debug("scKey:{}", scKey);
            } else if (key.isReadable()) { // å¦‚æœæ˜¯ read
                try {
                    SocketChannel channel = (SocketChannel) key.channel(); // æ‹¿åˆ°è§¦å‘äº‹ä»¶çš„channel
                    // è·å– selectionKey ä¸Šå…³è”çš„é™„ä»¶
                    ByteBuffer buffer = (ByteBuffer) key.attachment();
                    int read = channel.read(buffer); // å¦‚æœæ˜¯æ­£å¸¸æ–­å¼€ï¼Œread çš„æ–¹æ³•çš„è¿”å›å€¼æ˜¯ -1
                    if(read == -1) {
                        key.cancel();
                    } else {
                        split(buffer);
                        // éœ€è¦æ‰©å®¹
                        if (buffer.position() == buffer.limit()) {
                            ByteBuffer newBuffer = ByteBuffer.allocate(buffer.capacity() * 2);
                            buffer.flip();
                            newBuffer.put(buffer); // 0123456789abcdef3333\n
                            key.attach(newBuffer);
                        }
                    }

                } catch (IOException e) {
                    e.printStackTrace();
                    key.cancel();  // å› ä¸ºå®¢æˆ·ç«¯æ–­å¼€äº†,å› æ­¤éœ€è¦å°† key å–æ¶ˆï¼ˆä» selector çš„ keys é›†åˆä¸­çœŸæ­£åˆ é™¤ keyï¼‰
                }
            }
        }
    }
}
```

å®¢æˆ·ç«¯

```java
SocketChannel sc = SocketChannel.open();
sc.connect(new InetSocketAddress("localhost", 8080));
SocketAddress address = sc.getLocalAddress();
// sc.write(Charset.defaultCharset().encode("hello\nworld\n"));
sc.write(Charset.defaultCharset().encode("0123\n456789abcdef"));
sc.write(Charset.defaultCharset().encode("0123456789abcdef3333\n"));
System.in.read();
```

#### 3.5.2 ByteBuffer å¤§å°åˆ†é…

* æ¯ä¸ª channel éƒ½éœ€è¦è®°å½•å¯èƒ½è¢«åˆ‡åˆ†çš„æ¶ˆæ¯ï¼Œå› ä¸º ByteBuffer ä¸èƒ½è¢«å¤šä¸ª channel å…±åŒä½¿ç”¨ï¼Œå› æ­¤éœ€è¦ä¸ºæ¯ä¸ª Channel ç»´æŠ¤ä¸€ä¸ªç‹¬ç«‹çš„ ByteBufferã€‚æ‰€ä»¥åœ¨å¤„ç†Acceptäº‹ä»¶æ—¶ï¼Œä¼šåœ¨æ³¨å†ŒSelectoræ—¶ï¼Œä¼ å…¥ä¸€ä¸ªByteBufferï¼ˆé™„ä»¶ï¼‰ï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½å°†ByteBufferä¸æ¯ä¸€ä¸ªSocketChannelè¿›è¡Œç»‘å®šã€‚
* ByteBuffer ä¸èƒ½å¤ªå¤§ï¼Œæ¯”å¦‚ä¸€ä¸ª ByteBuffer 1MBçš„è¯ï¼Œè¦æ”¯æŒç™¾ä¸‡è¿æ¥å°±è¦1Tbå†…å­˜ï¼Œå› æ­¤éœ€è¦è®¾è®¡å¤§å°å¯å˜çš„ ByteBuffer
  * ä¸€ç§æ€è·¯æ˜¯é¦–å…ˆåˆ†é…ä¸€ä¸ªè¾ƒå°çš„ bufferï¼Œä¾‹å¦‚ 4kï¼Œå¦‚æœå‘ç°æ•°æ®ä¸å¤Ÿï¼Œå†åˆ†é…8kçš„ bufferï¼Œå°†4kbuffer å†…å®¹æ‹·è´è‡³ 8k bufferï¼Œä¼˜ç‚¹æ˜¯æ¶ˆæ¯è¿ç»­å®¹æ˜“å¤„ç†ï¼Œç¼ºç‚¹æ˜¯æ•°æ®æ‹·è´è€—è´¹æ€§èƒ½ï¼Œå‚è€ƒå®ç° [http://tutorials.jenkov.com/java-performance/resizable-array.html](http://tutorials.jenkov.com/java-performance/resizable-array.html)
  * å¦ä¸€ç§æ€è·¯æ˜¯ç”¨å¤šä¸ªæ•°ç»„ç»„æˆ bufferï¼Œä¸€ä¸ªæ•°ç»„ä¸å¤Ÿï¼ŒæŠŠå¤šå‡ºæ¥çš„å†…å®¹å†™å…¥æ–°çš„æ•°ç»„ï¼Œä¸å‰é¢çš„åŒºåˆ«æ˜¯æ¶ˆæ¯å­˜å‚¨ä¸è¿ç»­è§£æå¤æ‚ï¼Œä¼˜ç‚¹æ˜¯é¿å…äº†æ‹·è´å¼•èµ·çš„æ€§èƒ½æŸè€—

### 3.6 å¤„ç†writeäº‹ä»¶

* éé˜»å¡æ¨¡å¼ä¸‹ï¼Œæ— æ³•ä¿è¯æŠŠ buffer ä¸­æ‰€æœ‰æ•°æ®éƒ½å†™å…¥ channelï¼Œå› æ­¤éœ€è¦è¿½è¸ª write æ–¹æ³•çš„è¿”å›å€¼ï¼ˆä»£è¡¨å®é™…å†™å…¥å­—èŠ‚æ•°ï¼‰
* ç”¨ selector ç›‘å¬æ‰€æœ‰ channel çš„å¯å†™äº‹ä»¶ï¼Œæ¯ä¸ª channel éƒ½éœ€è¦ä¸€ä¸ª key æ¥è·Ÿè¸ª bufferï¼Œä½†è¿™æ ·åˆä¼šå¯¼è‡´å ç”¨å†…å­˜è¿‡å¤šï¼Œå°±æœ‰ä¸¤é˜¶æ®µç­–ç•¥
  * å½“æ¶ˆæ¯å¤„ç†å™¨ç¬¬ä¸€æ¬¡å†™å…¥æ¶ˆæ¯æ—¶ï¼Œæ‰å°† channel æ³¨å†Œåˆ° selector ä¸Š
  * selector æ£€æŸ¥ channel ä¸Šçš„å¯å†™äº‹ä»¶ï¼Œå¦‚æœæ‰€æœ‰çš„æ•°æ®å†™å®Œäº†ï¼Œå°±å–æ¶ˆ channel çš„æ³¨å†Œ
  * å¦‚æœä¸å–æ¶ˆï¼Œä¼šæ¯æ¬¡å¯å†™å‡ä¼šè§¦å‘ write äº‹ä»¶

```java
public class WriteServer {

    public static void main(String[] args) throws IOException {
        ServerSocketChannel ssc = ServerSocketChannel.open();
        ssc.configureBlocking(false);
        ssc.bind(new InetSocketAddress(8080));

        Selector selector = Selector.open();
        ssc.register(selector, SelectionKey.OP_ACCEPT);

        while(true) {
            selector.select();

            Iterator<SelectionKey> iter = selector.selectedKeys().iterator();
            while (iter.hasNext()) {
                SelectionKey key = iter.next();
                iter.remove();
                if (key.isAcceptable()) {
                    SocketChannel sc = ssc.accept();
                    sc.configureBlocking(false);
                    SelectionKey sckey = sc.register(selector, SelectionKey.OP_READ);
                    // 1. å‘å®¢æˆ·ç«¯å‘é€å†…å®¹
                    StringBuilder sb = new StringBuilder();
                    for (int i = 0; i < 3000000; i++) {
                        sb.append("a");
                    }
                    ByteBuffer buffer = Charset.defaultCharset().encode(sb.toString());
                    int write = sc.write(buffer);
                    // 3. write è¡¨ç¤ºå®é™…å†™äº†å¤šå°‘å­—èŠ‚
                    System.out.println("å®é™…å†™å…¥å­—èŠ‚:" + write);
                    // 4. å¦‚æœæœ‰å‰©ä½™æœªè¯»å­—èŠ‚ï¼Œæ‰éœ€è¦å…³æ³¨å†™äº‹ä»¶
                    if (buffer.hasRemaining()) {
                        // read 1  write 4
                        // åœ¨åŸæœ‰å…³æ³¨äº‹ä»¶çš„åŸºç¡€ä¸Šï¼Œå¤šå…³æ³¨ å†™äº‹ä»¶
                        sckey.interestOps(sckey.interestOps() + SelectionKey.OP_WRITE);
                        // æŠŠ buffer ä½œä¸ºé™„ä»¶åŠ å…¥ sckey
                        sckey.attach(buffer);
                    }
                } else if (key.isWritable()) {
                    ByteBuffer buffer = (ByteBuffer) key.attachment();
                    SocketChannel sc = (SocketChannel) key.channel();
                    int write = sc.write(buffer);
                    System.out.println("å®é™…å†™å…¥å­—èŠ‚:" + write);
                    if (!buffer.hasRemaining()) { // å†™å®Œäº†
                        key.interestOps(key.interestOps() - SelectionKey.OP_WRITE);
                        key.attach(null);
                    }
                }
            }
        }
    }
}
```

å®¢æˆ·ç«¯

```java
public class WriteClient {
    public static void main(String[] args) throws IOException {
        Selector selector = Selector.open();
        SocketChannel sc = SocketChannel.open();
        sc.configureBlocking(false);
        sc.register(selector, SelectionKey.OP_CONNECT | SelectionKey.OP_READ);
        sc.connect(new InetSocketAddress("localhost", 8080));
        int count = 0;
        while (true) {
            selector.select();
            Iterator<SelectionKey> iter = selector.selectedKeys().iterator();
            while (iter.hasNext()) {
                SelectionKey key = iter.next();
                iter.remove();
                if (key.isConnectable()) {
                    System.out.println(sc.finishConnect());
                } else if (key.isReadable()) {
                    ByteBuffer buffer = ByteBuffer.allocate(1024 * 1024);
                    count += sc.read(buffer);
                    buffer.clear();
                    System.out.println(count);
                }
            }
        }
    }
}
```

**ğŸ’¡ write ä¸ºä½•è¦å–æ¶ˆ**

åªè¦å‘ channel å‘é€æ•°æ®æ—¶ï¼Œsocket ç¼“å†²å¯å†™ï¼Œè¿™ä¸ªäº‹ä»¶ä¼šé¢‘ç¹è§¦å‘ï¼Œå› æ­¤åº”å½“åªåœ¨ socket ç¼“å†²åŒºå†™ä¸ä¸‹æ—¶å†å…³æ³¨å¯å†™äº‹ä»¶ï¼Œæ•°æ®å†™å®Œä¹‹åå†å–æ¶ˆå…³æ³¨

## å››. å¤šçº¿ç¨‹ä¼˜åŒ–

åœ¨ä¸Šé¢çš„ä»£ç ä¸­æˆ‘ä»¬å°†Acceptã€Readã€Writeäº‹ä»¶æ”¾åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­å¤„ç†ã€‚å¦‚æœé‡åˆ°Readå’ŒWriteä¸€ä¸ªè¾ƒå¤§æ•°æ®é‡çš„åœºæ™¯æ—¶ï¼Œé‚£ä¹ˆè½®è¯¢ç­–ç•¥ä¼šå› ä¸ºReadå’ŒWriteçš„è€—æ—¶å¯¼è‡´æ•´ä¸ªSelectå¾ªç¯æœºåˆ¶æ¥è¿‘å¤±æ•ˆã€‚ä¸¾ä¸ªæ —å­ï¼šç°åœ¨æœ‰ä¸€ä¸ªReadæ“ä½œéœ€è¦è€—æ—¶0.5Sï¼Œé‚£ä¹ˆåœ¨è¿™0.5Sä¸­å¾ªç¯ä¼šè¢«é˜»å¡åœ¨Readæ–¹æ³•ä¸Šï¼Œæœ€ç»ˆå¯¼è‡´å…¶å®ƒChannelçš„æ‰€æœ‰äº‹ä»¶éƒ½æ— æ³•å¾—åˆ°å¤„ç†ï¼Œæ­¤æ—¶æˆ‘ä»¬å°±éœ€è¦åˆ©ç”¨å¤šçº¿ç¨‹å¯¹æ•´ä¸ªå¤„ç†æµç¨‹è¿›è¡Œä¼˜åŒ–ã€‚

ç”±äºAcceptäº‹ä»¶å¹¶ä¸æ˜¯ä¸€ä¸ªè€—æ—¶æ“ä½œï¼Œæˆ‘ä»¬å°†ä¸»çº¿ç¨‹ä¸“é—¨ç”¨äºå¤„ç†å®¢æˆ·ç«¯è¿æ¥äº‹ä»¶ï¼ˆAcceptï¼‰ã€‚è€ŒacceptæˆåŠŸåæˆ‘ä»¬å°†`SocketChannel`äº¤ç”±Workerçº¿ç¨‹å»å¤„ç†`write/read`äº‹ä»¶ã€‚è€ŒWorkerçº¿ç¨‹æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ± åŒ–æŠ€æœ¯ï¼Œå°†SocketChannelåˆ†å‘åˆ°å¤šä¸ªçº¿ç¨‹ä¸­å»æ‰§è¡Œã€‚

![](../images/12.png)

```java
/**
 * å¤šçº¿ç¨‹ç‰ˆæœ¬NIO
 *
 * @author: Jindong.Tian
 * @date: 2021-06-06
 **/
@Slf4j
public class ServerTest {

    private static final int WORKER_NUMBER = 5;

    public static void main(String[] args) throws IOException {

        Selector selector = Selector.open();

        ServerSocketChannel serverSocketChannel = ServerSocketChannel.open();
        serverSocketChannel.configureBlocking(false);
        serverSocketChannel.bind(new InetSocketAddress(8080));
        SelectionKey sscSelectionKey = serverSocketChannel.register(selector, 0, null);
        sscSelectionKey.interestOps(SelectionKey.OP_ACCEPT);

        //åˆå§‹åŒ–Worker
        Worker[] workers = new Worker[WORKER_NUMBER];
        for (int i = 0; i < WORKER_NUMBER; i++) {
            workers[i] = new Worker("work-" + i);
        }
        int index = 0;
        while (true) {
            selector.select();
            if (sscSelectionKey.isAcceptable()) {
                SocketChannel sc = serverSocketChannel.accept();
                sc.configureBlocking(false);
                log.info("before register worker");
                workers[index].register(sc);
                log.info("after register worker");
            }
            index++;
            // é˜²æ­¢intè¶Šç•Œ
            index = index % WORKER_NUMBER;
        }
    }

    /**
     * Workerä¸“é—¨ç”¨äºå¤„ç†Readå’ŒWriteäº‹ä»¶
     */
    private static class Worker implements Runnable {
        private volatile Thread thread;
        private String name;
        private Selector selector;
        private final ConcurrentLinkedQueue<Runnable> task = new ConcurrentLinkedQueue<>();

        public Worker(String name) throws IOException {
            this.name = name;
            this.selector = Selector.open();
        }

        public void register(SocketChannel socketChannel) throws ClosedChannelException {
            if (thread == null) {
                synchronized (this) {
                    if (thread == null) {
                        this.thread = new Thread(this);
                        this.thread.start();
                    }
                }
            }
            // å¦‚æœSelector.select()æ–¹æ³•æ­£åœ¨è¢«é˜»å¡ï¼Œé‚£ä¹ˆæ­¤æ—¶è°ƒç”¨SocketChannel.registerå°†Selectorä¸SocketChannelç»‘å®šä¹Ÿä¼šé˜»å¡ã€‚
            // å°†ç»‘å®šæ“ä½œæ”¾åˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œè¿™æ ·æˆ‘ä»¬å°†ç»‘å®šæ“ä½œå»¶åå¤„ç†ï¼Œæ‰èƒ½ä¿è¯registeræ–¹æ³•å’Œselectæ–¹æ³•çš„é¡ºåº
            task.offer(() -> {
                try {
                    socketChannel.register(this.selector, SelectionKey.OP_READ);
                } catch (ClosedChannelException e) {
                    e.printStackTrace();
                }
            });
            //æ‰‹åŠ¨å”¤é†’Selectorï¼Œæ­¤æ—¶å› ä¸ºæ²¡æœ‰äº‹ä»¶å‘ç”Ÿè€Œé˜»å¡çš„selectæ–¹æ³•ä¼šç›´æ¥è¿”å›
            selector.wakeup();
        }

        @Override
        public void run() {
            while (true) {
                try {
                    this.selector.select();
                    //è·å–é˜Ÿåˆ—ä¸­æš‚å­˜çš„ä»»åŠ¡
                    Runnable task = this.task.poll();
                    if (task != null) {
                        task.run();
                    }
                    Set<SelectionKey> selectionKeys = this.selector.selectedKeys();
                    Iterator<SelectionKey> iterator = selectionKeys.iterator();
                    while (iterator.hasNext()) {
                        SelectionKey selectionKey = iterator.next();
                        SocketChannel channel = (SocketChannel) selectionKey.channel();
                        iterator.remove();
                        try {
                            if (selectionKey.isReadable()) {
                                // ..è¯»æ“ä½œ
                                ByteBuffer buffer = ByteBuffer.allocate(16);
                                int length = channel.read(buffer);
                                if (length == -1) {
                                    //æ­£å¸¸é€€å‡ºï¼Œåæ³¨å†Œ
                                    selectionKey.cancel();
                                    channel.close();
                                    log.info("å®¢æˆ·ç«¯æ­£å¸¸é€€å‡º->{}", this.name);
                                } else {
                                    buffer.flip();
                                    debugAll(buffer);
                                }
                            } else if (selectionKey.isWritable()) {
                                // ..å†™æ“ä½œ
                            }
                        } catch (IOException e) {
                            //éæ­£å¸¸é€€å‡º
                            log.info("å®¢æˆ·ç«¯éæ­£å¸¸é€€å‡º->{}", this.name);
                            selectionKey.cancel();
                            try {
                                channel.close();
                            } catch (IOException ioException) {
                                ioException.printStackTrace();
                            }
                        }
                    }
                } catch (IOException e) {
                    e.printStackTrace();
                }
            }

        }
    }
}

```

 **ğŸ’¡å¦‚ä½•æ‹¿åˆ° cpu ä¸ªæ•°**

> * Runtime.getRuntime().availableProcessors() å¦‚æœå·¥ä½œåœ¨ docker å®¹å™¨ä¸‹ï¼Œå› ä¸ºå®¹å™¨ä¸æ˜¯ç‰©ç†éš”ç¦»çš„ï¼Œä¼šæ‹¿åˆ°ç‰©ç† cpu ä¸ªæ•°ï¼Œè€Œä¸æ˜¯å®¹å™¨ç”³è¯·æ—¶çš„ä¸ªæ•°
> * è¿™ä¸ªé—®é¢˜ç›´åˆ° JDK 10æ‰ä¿®å¤ï¼Œä½¿ç”¨ jvm å‚æ•° UseContainerSupport é…ç½®ï¼Œ é»˜è®¤å¼€å¯

