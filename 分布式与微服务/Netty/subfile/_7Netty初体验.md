# Nettyåˆä½“éªŒ

## ä¸€. æ¦‚è¿°

### 1.1 Netty æ˜¯ä»€ä¹ˆï¼Ÿ

```
Netty is an asynchronous event-driven network application framework
for rapid development of maintainable high performance protocol servers & clients.
```

Netty æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„ã€åŸºäºäº‹ä»¶é©±åŠ¨çš„ç½‘ç»œåº”ç”¨æ¡†æ¶ï¼Œç”¨äºå¿«é€Ÿå¼€å‘å¯ç»´æŠ¤ã€é«˜æ€§èƒ½çš„ç½‘ç»œæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯

### 1.2 Nettyåœ°ä½

Netty åœ¨ Java ç½‘ç»œåº”ç”¨æ¡†æ¶ä¸­çš„åœ°ä½å°±å¥½æ¯”ï¼šSpring æ¡†æ¶åœ¨ JavaEE å¼€å‘ä¸­çš„åœ°ä½

ä»¥ä¸‹çš„æ¡†æ¶éƒ½ä½¿ç”¨äº† Nettyï¼Œå› ä¸ºå®ƒä»¬æœ‰ç½‘ç»œé€šä¿¡éœ€æ±‚ï¼

* Cassandra - nosql æ•°æ®åº“
* Spark - å¤§æ•°æ®åˆ†å¸ƒå¼è®¡ç®—æ¡†æ¶
* Hadoop - å¤§æ•°æ®åˆ†å¸ƒå¼å­˜å‚¨æ¡†æ¶
* RocketMQ - ali å¼€æºçš„æ¶ˆæ¯é˜Ÿåˆ—
* ElasticSearch - æœç´¢å¼•æ“
* gRPC - rpc æ¡†æ¶
* Dubbo - rpc æ¡†æ¶
* Spring 5.x - flux api å®Œå…¨æŠ›å¼ƒäº† tomcat ï¼Œä½¿ç”¨ netty ä½œä¸ºæœåŠ¡å™¨ç«¯
* Zookeeper - åˆ†å¸ƒå¼åè°ƒæ¡†æ¶

### 1.3 Netty çš„ä¼˜åŠ¿

* Netty vs NIOï¼Œå·¥ä½œé‡å¤§ï¼Œbug å¤š
  * éœ€è¦è‡ªå·±æ„å»ºåè®®
  * è§£å†³ TCP ä¼ è¾“é—®é¢˜ï¼Œå¦‚ç²˜åŒ…ã€åŠåŒ…
  * epoll ç©ºè½®è¯¢å¯¼è‡´ CPU 100%
  * å¯¹ API è¿›è¡Œå¢å¼ºï¼Œä½¿ä¹‹æ›´æ˜“ç”¨ï¼Œå¦‚ FastThreadLocal => ThreadLocalï¼ŒByteBuf => ByteBuffer
* Netty vs å…¶å®ƒç½‘ç»œåº”ç”¨æ¡†æ¶
  * Mina ç”± apache ç»´æŠ¤ï¼Œå°†æ¥ 3.x ç‰ˆæœ¬å¯èƒ½ä¼šæœ‰è¾ƒå¤§é‡æ„ï¼Œç ´å API å‘ä¸‹å…¼å®¹æ€§ï¼ŒNetty çš„å¼€å‘è¿­ä»£æ›´è¿…é€Ÿï¼ŒAPI æ›´ç®€æ´ã€æ–‡æ¡£æ›´ä¼˜ç§€
  * ä¹…ç»è€ƒéªŒï¼Œ16å¹´ï¼ŒNetty ç‰ˆæœ¬
    * 2.x 2004
    * 3.x 2008
    * 4.x 2013
    * 5.x å·²åºŸå¼ƒï¼ˆæ²¡æœ‰æ˜æ˜¾çš„æ€§èƒ½æå‡ï¼Œç»´æŠ¤æˆæœ¬é«˜ï¼‰

## äºŒ. Hello World

### 2.1 ç›®æ ‡

å¼€å‘ä¸€ä¸ªç®€å•çš„æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯

* å®¢æˆ·ç«¯å‘æœåŠ¡å™¨ç«¯å‘é€ hello, world
* æœåŠ¡å™¨ä»…æ¥æ”¶ï¼Œä¸è¿”å›

åŠ å…¥ä¾èµ–

```xml
<dependency>
    <groupId>io.netty</groupId>
    <artifactId>netty-all</artifactId>
    <version>4.1.39.Final</version>
</dependency>
```

### 2.2 æœåŠ¡å™¨ç«¯

```java
new ServerBootstrap()
    .group(new NioEventLoopGroup()) // 1
    .channel(NioServerSocketChannel.class) // 2
    .childHandler(new ChannelInitializer<NioSocketChannel>() { // 3
        protected void initChannel(NioSocketChannel ch) {
            ch.pipeline().addLast(new StringDecoder()); // 5
            ch.pipeline().addLast(new SimpleChannelInboundHandler<String>() { // 6
                @Override
                protected void channelRead0(ChannelHandlerContext ctx, String msg) {
                    System.out.println(msg);
                }
            });
        }
    })
    .bind(8080); // 4
```

ä»£ç è§£è¯»

* 1 å¤„ï¼Œåˆ›å»º NioEventLoopGroupï¼Œå¯ä»¥ç®€å•ç†è§£ä¸º `çº¿ç¨‹æ±  + Selector` åé¢ä¼šè¯¦ç»†å±•å¼€

* 2 å¤„ï¼Œé€‰æ‹©æœåŠ¡ Scoket å®ç°ç±»ï¼Œå…¶ä¸­ NioServerSocketChannel è¡¨ç¤ºåŸºäº NIO çš„æœåŠ¡å™¨ç«¯å®ç°ï¼Œå…¶å®ƒå®ç°è¿˜æœ‰

  ![](../images/17.png)

* 3 å¤„ï¼Œä¸ºå•¥æ–¹æ³•å« childHandlerï¼Œæ˜¯æ¥ä¸‹æ¥æ·»åŠ çš„å¤„ç†å™¨éƒ½æ˜¯ç»™ SocketChannel ç”¨çš„ï¼Œè€Œä¸æ˜¯ç»™ ServerSocketChannelã€‚ChannelInitializer å¤„ç†å™¨ï¼ˆä»…æ‰§è¡Œä¸€æ¬¡ï¼‰ï¼Œå®ƒçš„ä½œç”¨æ˜¯å¾…å®¢æˆ·ç«¯ SocketChannel å»ºç«‹è¿æ¥åï¼Œæ‰§è¡Œ initChannel ä»¥ä¾¿æ·»åŠ æ›´å¤šçš„å¤„ç†å™¨

* 4 å¤„ï¼ŒServerSocketChannel ç»‘å®šçš„ç›‘å¬ç«¯å£

* 5 å¤„ï¼ŒSocketChannel çš„å¤„ç†å™¨ï¼Œè§£ç  ByteBuf => String

* 6 å¤„ï¼ŒSocketChannel çš„ä¸šåŠ¡å¤„ç†å™¨ï¼Œä½¿ç”¨ä¸Šä¸€ä¸ªå¤„ç†å™¨çš„å¤„ç†ç»“æœ

### 2.3 å®¢æˆ·ç«¯

```java
new Bootstrap()
    .group(new NioEventLoopGroup()) // 1
    .channel(NioSocketChannel.class) // 2
    .handler(new ChannelInitializer<Channel>() { // 3
        @Override
        protected void initChannel(Channel ch) {
            ch.pipeline().addLast(new StringEncoder()); // 8
        }
    })
    .connect("127.0.0.1", 8080) // 4
    .sync() // 5
    .channel() // 6
    .writeAndFlush(new Date() + ": hello world!"); // 7
```

ä»£ç è§£è¯»

* 1 å¤„ï¼Œåˆ›å»º NioEventLoopGroupï¼ŒåŒ Server

* 2 å¤„ï¼Œé€‰æ‹©å®¢æˆ· Socket å®ç°ç±»ï¼ŒNioSocketChannel è¡¨ç¤ºåŸºäº NIO çš„å®¢æˆ·ç«¯å®ç°ï¼Œå…¶å®ƒå®ç°è¿˜æœ‰

  ![](../images/18.png)

* 3 å¤„ï¼Œæ·»åŠ  SocketChannel çš„å¤„ç†å™¨ï¼ŒChannelInitializer å¤„ç†å™¨ï¼ˆä»…æ‰§è¡Œä¸€æ¬¡ï¼‰ï¼Œå®ƒçš„ä½œç”¨æ˜¯å¾…å®¢æˆ·ç«¯ SocketChannel å»ºç«‹è¿æ¥åï¼Œæ‰§è¡Œ initChannel ä»¥ä¾¿æ·»åŠ æ›´å¤šçš„å¤„ç†å™¨

* 4 å¤„ï¼ŒæŒ‡å®šè¦è¿æ¥çš„æœåŠ¡å™¨å’Œç«¯å£

* 5 å¤„ï¼ŒNetty ä¸­å¾ˆå¤šæ–¹æ³•éƒ½æ˜¯å¼‚æ­¥çš„ï¼Œå¦‚ connectï¼Œè¿™æ—¶éœ€è¦ä½¿ç”¨ sync æ–¹æ³•ç­‰å¾… connect å»ºç«‹è¿æ¥å®Œæ¯•

* 6 å¤„ï¼Œè·å– channel å¯¹è±¡ï¼Œå®ƒå³ä¸ºé€šé“æŠ½è±¡ï¼Œå¯ä»¥è¿›è¡Œæ•°æ®è¯»å†™æ“ä½œ

* 7 å¤„ï¼Œå†™å…¥æ¶ˆæ¯å¹¶æ¸…ç©ºç¼“å†²åŒº

* 8 å¤„ï¼Œæ¶ˆæ¯ä¼šç»è¿‡é€šé“ handler å¤„ç†ï¼Œè¿™é‡Œæ˜¯å°† String => ByteBuf å‘å‡º

* æ•°æ®ç»è¿‡ç½‘ç»œä¼ è¾“ï¼Œåˆ°è¾¾æœåŠ¡å™¨ç«¯ï¼ŒæœåŠ¡å™¨ç«¯ 5 å’Œ 6 å¤„çš„ handler å…ˆåè¢«è§¦å‘ï¼Œèµ°å®Œä¸€ä¸ªæµç¨‹

### 2.4 æµç¨‹æ¢³ç†

![](../images/19.png)

#### ğŸ’¡ æç¤º

> ä¸€å¼€å§‹éœ€è¦æ ‘ç«‹æ­£ç¡®çš„è§‚å¿µ
>
> * æŠŠ channel ç†è§£ä¸ºæ•°æ®çš„é€šé“
> * æŠŠ msg ç†è§£ä¸ºæµåŠ¨çš„æ•°æ®ï¼Œæœ€å¼€å§‹è¾“å…¥æ˜¯ ByteBufï¼Œä½†ç»è¿‡ pipeline çš„åŠ å·¥ï¼Œä¼šå˜æˆå…¶å®ƒç±»å‹å¯¹è±¡ï¼Œæœ€åè¾“å‡ºåˆå˜æˆ ByteBuf
> * æŠŠ handler ç†è§£ä¸ºæ•°æ®çš„å¤„ç†å·¥åº
>   * å·¥åºæœ‰å¤šé“ï¼Œåˆåœ¨ä¸€èµ·å°±æ˜¯ pipelineï¼Œpipeline è´Ÿè´£å‘å¸ƒäº‹ä»¶ï¼ˆè¯»ã€è¯»å–å®Œæˆ...ï¼‰ä¼ æ’­ç»™æ¯ä¸ª handlerï¼Œ handler å¯¹è‡ªå·±æ„Ÿå…´è¶£çš„äº‹ä»¶è¿›è¡Œå¤„ç†ï¼ˆé‡å†™äº†ç›¸åº”äº‹ä»¶å¤„ç†æ–¹æ³•ï¼‰
>   * handler åˆ† Inbound å’Œ Outbound ä¸¤ç±»
> * æŠŠ eventLoop ç†è§£ä¸ºå¤„ç†æ•°æ®çš„å·¥äºº
>   * å·¥äººå¯ä»¥ç®¡ç†å¤šä¸ª channel çš„ io æ“ä½œï¼Œå¹¶ä¸”ä¸€æ—¦å·¥äººè´Ÿè´£äº†æŸä¸ª channelï¼Œå°±è¦è´Ÿè´£åˆ°åº•ï¼ˆç»‘å®šï¼‰
>   * å·¥äººæ—¢å¯ä»¥æ‰§è¡Œ io æ“ä½œï¼Œä¹Ÿå¯ä»¥è¿›è¡Œä»»åŠ¡å¤„ç†ï¼Œæ¯ä½å·¥äººæœ‰ä»»åŠ¡é˜Ÿåˆ—ï¼Œé˜Ÿåˆ—é‡Œå¯ä»¥å †æ”¾å¤šä¸ª channel çš„å¾…å¤„ç†ä»»åŠ¡ï¼Œä»»åŠ¡åˆ†ä¸ºæ™®é€šä»»åŠ¡ã€å®šæ—¶ä»»åŠ¡
>   * å·¥äººæŒ‰ç…§ pipeline é¡ºåºï¼Œä¾æ¬¡æŒ‰ç…§ handler çš„è§„åˆ’ï¼ˆä»£ç ï¼‰å¤„ç†æ•°æ®ï¼Œå¯ä»¥ä¸ºæ¯é“å·¥åºæŒ‡å®šä¸åŒçš„å·¥äºº 